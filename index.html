<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuantumM38 NFT Galerie</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h1>QuantumM38 NFT Galerie</h1>
  <button onclick="loadGallery()">üîÑ Galerie aktualisieren</button>
  <button onclick="withdraw()">üí∏ Einnahmen abheben</button>
  <div id="gallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 20px;"></div>

  <!-- ‚ÑπÔ∏è √úber das Projekt -->
  <section style="margin-top: 40px; padding: 20px; background: #f9f9f9; border-radius: 12px;">
    <h2>‚ÑπÔ∏è √úber das QuantumM38-Projekt</h2>
    <p>
      <strong>QuantumM38</strong> ist ein innovatives NFT-Projekt, das echte Quantenzufallszahlen nutzt, um einzigartige Mandala-Kunstwerke zu erzeugen. Jeder NFT wird vollst√§ndig dezentral auf der Ethereum-Blockchain erstellt und ist garantiert einzigartig.
    </p>
    <p>
      Durch die Verbindung von Web3, IPFS und echter Zufallsphysik (z.‚ÄØB. √ºber Chainlink VRF oder QRNG) hebt sich QuantumM38 von klassischen NFT-Projekten ab.
    </p>
    <p>
      Du kannst auf dieser Seite NFTs direkt minten, anzeigen, auf OpenSea verkaufen oder einfach sammeln.
    </p>
  </section>

  <script>
    const abi = [
      {
        "inputs": [],
        "name": "tokenCounter",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [{ "internalType": "uint256", "name": "tokenId", "type": "uint256" }],
        "name": "tokenURI",
        "outputs": [{ "internalType": "string", "name": "", "type": "string" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "withdraw",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    const contractAddress = "0x3692f4186a852A99bC4410781352686fbE152060";

    async function loadGallery() {
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const contract = new ethers.Contract(contractAddress, abi, signer);

      const count = await contract.tokenCounter();
      const gallery = document.getElementById("gallery");
      gallery.innerHTML = "";

      for (let i = 0; i < count; i++) {
        try {
          const uri = await contract.tokenURI(i);
          const httpUrl = uri.replace("ipfs://", "https://ipfs.io/ipfs/");
          const response = await fetch(httpUrl);
          const metadata = await response.json();

          let attributesHTML = "";
          if (metadata.attributes && Array.isArray(metadata.attributes)) {
            attributesHTML = "<ul style='list-style:none; padding:0;'>";
            for (const attr of metadata.attributes) {
              attributesHTML += `<li><strong>${attr.trait_type}:</strong> ${attr.value}</li>`;
            }
            attributesHTML += "</ul>";
          }

          const imgUrl = metadata.image.replace("ipfs://", "https://ipfs.io/ipfs/");
          const openSeaUrl = `https://testnets.opensea.io/assets/sepolia/${contractAddress}/${i}`;
          const openSeaSellUrl = `${openSeaUrl}/sell`;

          const card = document.createElement("div");
          card.style.border = "1px solid #ccc";
          card.style.borderRadius = "12px";
          card.style.padding = "12px";
          card.style.boxShadow = "0 4px 10px rgba(0, 0, 0, 0.1)";
          card.style.backgroundColor = "#fff";
          card.style.textAlign = "center";

          card.innerHTML = `
            <h3>${metadata.name}</h3>
            <img src="${imgUrl}" alt="${metadata.name}" style="max-width: 100%;" />
            <p>${metadata.description}</p>
            ${attributesHTML}
            <a href="${openSeaUrl}" target="_blank">üåê Auf OpenSea anzeigen</a><br/>
            <button onclick="window.open('${openSeaSellUrl}', '_blank')">üõí Verkaufen</button>
          `;

          gallery.appendChild(card);
        } catch (e) {
          console.warn("‚ùå Fehler bei Token", i, e);
        }
      }
    }
    async function withdraw() {
      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const contract = new ethers.Contract(contractAddress, abi, signer);

        const tx = await contract.withdraw();
        alert("‚è≥ Auszahlung l√§uft‚Ä¶ TX: " + tx.hash);
        await tx.wait();
        alert("‚úÖ Einnahmen erfolgreich abgehoben!");
        showContractBalance(); // üîÑ Balance nach Auszahlung aktualisieren
      } catch (e) {
        console.error("‚ùå Fehler beim Auszahlen:", e);
        alert("Fehler beim Auszahlen ‚Äì siehe Konsole.");
      }
    }

    async function showContractBalance() {
      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const balanceWei = await provider.getBalance(contractAddress);
        const balanceEth = ethers.utils.formatEther(balanceWei);
        document.getElementById("contractBalance").innerText = `üí∞ Contract-Balance: ${balanceEth} ETH`;
      } catch (err) {
        console.error("‚ùå Fehler beim Laden der Contract-Balance:", err);
        document.getElementById("contractBalance").innerText = "üí∞ Contract-Balance: Fehler";
      }
    }

    if (typeof window.ethereum !== "undefined") {
      window.ethereum.request({ method: "eth_requestAccounts" }).then(() => {
        loadGallery();
        showContractBalance();
      });
    }
  </script>
</body>
</html>